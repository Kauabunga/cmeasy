{"version":3,"sources":["../../server/routes-cmeasy.js"],"names":[],"mappings":"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","file":"routes-cmeasy.js","sourcesContent":["/**\n * Cmeasy application routes\n */\n\n'use strict';\n\nimport renderIndex from './components/render-index/index';\nimport auth from './auth/index';\nimport user from './api/user/index';\nimport _ from 'lodash';\nimport Promise from 'bluebird';\n\n/**\n *\n */\nexport default function(app, cmeasy) {\n\n  app.use(`/${cmeasy.getRootRoute()}/auth`, auth);\n  app.use(`/${cmeasy.getApiRoute()}/v1/users`, user);\n\n  app.use(`/${cmeasy.getApiRoute()}/v1/content/schemacomplete`, getCompleteSchemaList(cmeasy));\n\n  app.use(`/${cmeasy.getApiRoute()}/v1/content/schema`, routeSchemaRequest(cmeasy));\n  app.use(`/${cmeasy.getApiRoute()}/v1/content/:type?`, routeContentRequest(cmeasy));\n  app.use(`/${cmeasy.getApiRoute()}/v1/content.js`, routeContentJsRequest(cmeasy));\n\n  app.use(`/${cmeasy.getRootRoute()}`, renderIndex(app, cmeasy));\n\n}\n\n/**\n * TODO ensure that the connection to the database has been achieved before resolving any of these flows\n */\nfunction routeContentRequest(cmeasy){\n  return function(req, res, next){\n\n    console.log('Routing content request', req.params.type, req.url);\n\n    if( ! req.params.type ) {\n\n      //Get all content\n      return getAllContent(cmeasy)\n        .then(function (indexes){\n          console.log('All content', indexes);\n          return res.json(indexes);\n        })\n        .catch(function(err){\n          console.error('Error getting all content', err);\n          return res.sendStatus(500);\n        });\n\n    }\n    else {\n\n      //Return specific content\n      return getContentModel(cmeasy, req.params.type)\n        .then(function(cmeasyModel){\n          if(cmeasyModel){\n            return cmeasyModel.getModelCrud()(req, res, next);\n          }\n          else {\n            return res.sendStatus(404);\n          }\n        });\n\n    }\n  }\n}\n\n/**\n * TODO extend this so individual content pieces can be grabbed\n *\n * e.g. api/v1/content/homePage.js\n *\n * @param cmeasy\n */\nfunction routeContentJsRequest(cmeasy){\n\n  //TODO configure this\n  const prependJs = 'window._cmeasy_content = ';\n\n  return function(req, res, next) {\n\n    console.log('Routing content js request', req.params.type, req.url);\n\n    //Get all content as js\n    return getAllContent(cmeasy)\n      .then(function (indexes) {\n        console.log('All content as js', indexes);\n\n        return res.status(200)\n          .set('Cache-Control', 'no-cache, no-store, must-revalidate')\n          .set('Pragma', 'no-cache')\n          .set('Expires', 0)\n          .set('Content-Type', 'application/javascript')\n          .send(prependJs + JSON.stringify(indexes));\n      })\n      .catch(function (err) {\n        console.error('Error getting all content as js', err);\n        return res.sendStatus(500);\n      });\n\n  }\n\n}\n\n/**\n *\n * @param cmeasy\n * @param type\n * @returns {*}\n */\nfunction getContentModel(cmeasy, type){\n  return cmeasy.getSchemaController().index()\n    .then(filterSchemaById(cmeasy, type))\n    .then(function(schema){\n      if(! schema){\n        return undefined;\n      }\n      else {\n        var cmeasyModel = cmeasy.getModel(type);\n        if( ! cmeasyModel ){\n          return cmeasy.createModel(schema);\n        }\n        else {\n          return cmeasyModel;\n        }\n      }\n    });\n}\n\n/**\n *\n * @param cmeasy\n * @returns {*}\n */\nfunction getAllContent(cmeasy){\n  return cmeasy.getSchemaController().index()\n    .then(function(schemas){\n      return Promise.all(_(schemas)\n        .map(function(schema){\n          return [\n            cmeasy.getModel(schema.meta[cmeasy.getIdKey()]),\n            schema\n          ];\n        })\n        .map(function([model, schema]){\n          if(! model){\n            return cmeasy.createModel(schema).getModelController().indexClean();\n          }\n          else {\n            return model.getModelController().indexClean();\n          }\n        })\n        .map(function(index){\n          return index.then(function(indexResult){\n            //TODO should probably handle singleton differently here\n            if(indexResult.length > 0){\n              return {[indexResult[0][cmeasy.getIdKey()]]: indexResult };\n            }\n            else {\n              return {};\n            }\n          });\n        })\n        .value())\n        .then(function(indexes){\n          return _(indexes).reduce(_.merge);\n        });\n    });\n}\n\n/**\n *\n * @param cmeasy\n * @returns {Function}\n */\nfunction getCompleteSchemaList(cmeasy){\n  return function(req, res, next){\n    cmeasy.getSchemaController().index()\n      .then(function(completeSchema){\n        return res.status(200).json(completeSchema);\n      })\n      .catch(function(err){\n        console.error('Error getting compelte schema list', err);\n        return res.sendStatus(500);\n      });\n  }\n}\n\n\n\n/**\n *\n * @param type\n * @returns {Function}\n */\nfunction filterSchemaById(cmeasy, type){\n  return function(schemas){\n    return _(schemas).filter(function(schema){\n      return schema.meta[cmeasy.getIdKey()] === type;\n    }).first();\n  }\n}\n\n/**\n *\n */\nfunction routeSchemaRequest(cmeasy){\n  return function(req, res, next){\n\n    console.log('Routing schema request', req.url);\n\n    //get content type from req\n    return cmeasy.getSchemaCrud()(req, res, next);\n  }\n}\n\n"]}