{"version":3,"sources":["../../server/routes-cmeasy.js"],"names":[],"mappings":"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","file":"routes-cmeasy.js","sourcesContent":["'use strict';\n\nimport renderIndex from './components/render-index/index';\nimport auth from './auth/index';\nimport user from './api/user/index';\nimport _ from 'lodash';\nimport Promise from 'bluebird';\nconst debug = require('debug')(`cmeasy:routes:cmeasy`);\n\nexport default function(app, cmeasy) {\n  app.use(`/${cmeasy.getRootRoute()}/auth`, auth);\n  app.use(`/${cmeasy.getApiRoute()}/v1/users`, user);\n\n  app.use(`/${cmeasy.getApiRoute()}/v1/content/schemacomplete`, getCompleteSchemaList(cmeasy));\n\n  app.use(`/${cmeasy.getApiRoute()}/v1/content/schema`, routeSchemaRequest(cmeasy));\n  app.use(`/${cmeasy.getApiRoute()}/v1/content/:type?`, routeContentRequest(cmeasy));\n  app.use(`/${cmeasy.getApiRoute()}/v1/content.js`, routeContentJsRequest(cmeasy));\n\n  app.use(`/${cmeasy.getRootRoute()}`, renderIndex(app, cmeasy));\n}\n\n/**\n * TODO ensure that the connection to the database has been achieved before resolving any of these flows\n */\nfunction routeContentRequest(cmeasy) {\n  return (req, res, next) => {\n    debug(`Routing content request ${req.params.type}, ${req.url}`);\n\n    if (!req.params.type) {\n      debug('Getting all content');\n      return getAllContent(cmeasy)\n        .then((indexes) => {\n          return res.json(indexes);\n          debug(`All content ${JSON.stringify(indexes)}`);\n        })\n        .catch((err) => {\n          console.error('Error getting all content', err);\n          return res.sendStatus(500);\n        });\n    }\n\n    debug(`Return specific type: ${req.params.type}`);\n    return getContentModel(cmeasy, req.params.type)\n      .then((cmeasyModel) => {\n        if (!cmeasyModel) {\n          return res.sendStatus(404);\n        }\n\n        return cmeasyModel.getModelCrud()(req, res, next);\n      });\n  }\n}\n\n/**\n * TODO extend this so individual content pieces can be grabbed\n *\n * e.g. api/v1/content/homePage.js\n *\n * @param cmeasy\n */\nfunction routeContentJsRequest(cmeasy) {\n\n  //TODO configure this\n  const prependJs = 'window._cmeasy_content = ';\n\n  return (req, res, next) => {\n\n    debug(`Routing content js request ${req.params.type} ${req.url}`);\n\n    //Get all content as js\n    return getAllContent(cmeasy)\n      .then((indexes) => {\n        debug(`All content as js ${JSON.stringify(indexes)}`);\n\n        return res.status(200)\n          .set('Cache-Control', 'no-cache, no-store, must-revalidate')\n          .set('Pragma', 'no-cache')\n          .set('Expires', 0)\n          .set('Content-Type', 'application/javascript')\n          .send(prependJs + JSON.stringify(indexes));\n      })\n      .catch((err) => {\n        console.error('Error getting all content as js', err);\n        return res.sendStatus(500);\n      });\n\n  }\n\n}\n\nfunction getContentModel(cmeasy, type) {\n  return cmeasy.getSchemaController().index()\n    .then(filterSchemaById(cmeasy, type))\n    .then((schema) => {\n      if (!schema) {\n        return undefined;\n      }\n\n      const cmeasyModel = cmeasy.getModel(type);\n      if (!cmeasyModel) {\n        return cmeasy.createModel(schema);\n      }\n\n      return cmeasyModel;\n    });\n}\n\nfunction getAllContent(cmeasy) {\n  return cmeasy.getSchemaController().index()\n    .then((schemas) => {\n      return Promise.all(_(schemas)\n        .map((schema) => {\n          return [\n            cmeasy.getModel(schema.meta[cmeasy.getIdKey()]),\n            schema\n          ];\n        })\n        .map(([model, schema]) => {\n          if (!model) {\n            return cmeasy.createModel(schema).getModelController().indexClean();\n          }\n          else {\n            return model.getModelController().indexClean();\n          }\n        })\n        .map((index) => {\n          return index.then((indexResult) => {\n            //TODO should probably handle singleton differently here\n            if (indexResult.length > 0) {\n              return {[indexResult[0][cmeasy.getIdKey()]]: indexResult};\n            }\n\n            return {};\n          });\n        })\n        .value())\n        .then((indexes) => {\n          return _(indexes).reduce(_.merge);\n        });\n    });\n}\n\nfunction getCompleteSchemaList(cmeasy) {\n  return (req, res, next) => {\n    cmeasy.getSchemaController().index()\n      .then((completeSchema) => {\n        return res.status(200).json(completeSchema);\n      })\n      .catch((err) => {\n        console.error('Error getting compelte schema list', err);\n        return res.sendStatus(500);\n      });\n  }\n}\n\nfunction filterSchemaById(cmeasy, type) {\n  return (schemas) => {\n    return _(schemas).filter((schema) => {\n      return schema.meta[cmeasy.getIdKey()] === type;\n    })\n      .first();\n  }\n}\n\nfunction routeSchemaRequest(cmeasy) {\n  return (req, res, next) => {\n    debug(`Routing schema request ${req.url}`);\n    return cmeasy.getSchemaCrud()(req, res, next);\n  }\n}\n\n"]}