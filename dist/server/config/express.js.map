{"version":3,"sources":["../../../server/config/express.js"],"names":[],"mappings":"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","file":"express.js","sourcesContent":["/**\n * Express configuration\n */\n\n'use strict';\n\nimport express from 'express';\nimport favicon from 'serve-favicon';\nimport morgan from 'morgan';\nimport compression from 'compression';\nimport bodyParser from 'body-parser';\nimport methodOverride from 'method-override';\nimport cookieParser from 'cookie-parser';\nimport errorHandler from 'errorhandler';\nimport path from 'path';\nimport lusca from 'lusca';\nimport config from './environment/index';\nimport passport from 'passport';\nimport session from 'express-session';\nimport connectMongo from 'connect-mongo';\nimport mongoose from 'mongoose';\nvar mongoStore = connectMongo(session);\n\n/**\n *\n */\nexport default {\n  coreExpress: coreExpress,\n  staticExpress: staticExpress\n}\n\n/**\n *\n */\nfunction coreExpress(app, cmeasy){\n  var env = app.get('env');\n\n  //TODO what can we do with this - do we need to set a view engine? Can we see if one is already set?\n  app.set('views', config.root + '/server/views');\n  app.set('view engine', 'jade');\n\n  app.use(`/${cmeasy.getRootRoute()}`, compression());\n  app.use(`/${cmeasy.getRootRoute()}`, bodyParser.urlencoded({ extended: false }));\n  app.use(`/${cmeasy.getRootRoute()}`, bodyParser.json());\n  app.use(`/${cmeasy.getRootRoute()}`, methodOverride());\n  app.use(`/${cmeasy.getRootRoute()}`, cookieParser());\n  app.use(`/${cmeasy.getRootRoute()}`, passport.initialize());\n\n  // Persist sessions with mongoStore / sequelizeStore\n  // We need to enable sessions for passport-twitter because it's an\n  // oauth 1.0 strategy, and Lusca depends on sessions\n  app.use(`/${cmeasy.getRootRoute()}`, session({\n    secret: config.secrets.session,\n    saveUninitialized: true,\n    resave: false,\n    store: new mongoStore({\n      mongooseConnection: mongoose.connection,\n      db: 'cmeasy'\n    })\n  }));\n\n  /**\n   * Lusca - express server security\n   * https://github.com/krakenjs/lusca\n   */\n  /* istanbul ignore if */\n  if ('test' !== env) {\n    app.use(`/${cmeasy.getRootRoute()}`, lusca({\n      csrf: {\n        angular: true\n      },\n      xframe: 'SAMEORIGIN',\n      hsts: {\n        maxAge: 31536000, //1 year, in seconds\n        includeSubDomains: true,\n        preload: true\n      },\n      xssProtection: true\n    }));\n  }\n\n  /* istanbul ignore if */\n  if ('development' === env) {\n    try { app.use(`/${cmeasy.getRootRoute()}`, require('connect-livereload')()); }\n    catch(err) { console.error('Error loading connent-livereload module | app.env = ', env); }\n  }\n}\n\n/**\n *\n * @param app\n */\nfunction staticExpress(app, cmeasy){\n\n  var env = app.get('env');\n\n  //TODO what does this do to the other app?\n  app.set('appPath', path.join(config.root, 'client'));\n\n  /* istanbul ignore if */\n  if ('production' === env) {\n    app.use(`/${cmeasy.getRootRoute()}`, favicon(path.join(config.root, 'client', 'favicon.ico')));\n    app.use(`/${cmeasy.getRootRoute()}`, express.static(app.get('appPath')));\n    app.use(`/${cmeasy.getRootRoute()}`, morgan('dev'));\n  }\n\n\n  if ('development' === env || 'test' === env) {\n    app.use(`/${cmeasy.getRootRoute()}`, express.static(path.join(config.root, '.tmp')));\n    app.use(`/${cmeasy.getRootRoute()}`, express.static(app.get('appPath')));\n    app.use(`/${cmeasy.getRootRoute()}`, morgan('dev'));\n    app.use(`/${cmeasy.getRootRoute()}`, errorHandler()); // Error handler - has to be last\n  }\n}\n"]}