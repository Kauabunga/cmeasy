{"version":3,"sources":["../../server/cmeasy.js"],"names":[],"mappings":"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","file":"cmeasy.js","sourcesContent":["/**\n * Cmeasy\n */\n\n'use strict';\n\nimport _ from 'lodash';\n\nimport Promise from 'bluebird';\nvar mongoose = Promise.promisifyAll(require('mongoose'));\nmongoose.Promise = Promise;\n\nimport express from 'express';\n\nimport config from './config/environment/index';\n\nimport createModel from './components/cmeasy/cmeasy.model';\nimport createSchema from './components/cmeasy/cmeasy.schema';\n\nimport createModelController from './components/cmeasy/cmeasy.controller.model';\nimport createSchemaController from './components/cmeasy/cmeasy.controller.schema';\nimport createFormlyController from './components/cmeasy/cmeasy.controller.formly';\nimport createCrudController from './api/generated/index';\n\nconst CMEASY_ID = '_cmeasyId';\nconst CMEASY_INSTANCE_ID = '_cmeasyInstanceId';\n\n/**\n *\n */\nexport default class Cmeasy {\n\n  constructor(options = {}) {\n    this.name = options.name || 'Cmeasy';\n    this.options = new CmeasyOptions(options);\n    this.models = [];\n\n    this._schema = createSchema(this.getNamespace(), this.getMongoose(), this);\n    this._schemaController = createSchemaController(this);\n    this._schemaFormly = createFormlyController(this.getSchemaMetaId(), this.getSchemaController());\n    this._schemaCrud = createCrudController(this.getSchemaController(), this.getSchemaFormly());\n\n    return Promise.all(this.generateModels(options.models))\n      .then((models) => {\n        return (this);\n      });\n  }\n\n  generateModels(models) {\n    return _(models).map(this.initModel.bind(this)).value();\n  }\n\n  initModel(model) {\n    return this.getSchemaController()\n      .create(this.getModelSchema(model))\n      .then(this.getAsObject.bind(this))\n      .then(this.createModel.bind(this))\n      .catch(function(error) {\n        console.error('error', error);\n      });\n  }\n\n  createModel(model) {\n    var existingModel = this.getModel(model.meta._cmeasyId);\n\n    if (existingModel) {\n      return existingModel\n    }\n    else {\n      var newModel = new CmeasyModel(this, model);\n      this.models.push(newModel);\n      return newModel;\n    }\n  }\n\n  getAsObject(obj) {\n    return obj.toObject()\n  }\n\n  getModelSchema(model) {\n    return {\n      meta: {\n        [this.getIdKey()]: _.camelCase(model.name),\n        author: 'Cmeasy User',\n        comment: 'Cmeasy init',\n        singleton: model.singleton || false,\n        disableDelete: model.disableDelete || false,\n        disableCreate: model.disableCreate || false\n      },\n      definition: this.getDefaultDefinition(model.definition || {})\n    };\n  }\n\n  getDefaultDefinition(definition) {\n    var index = 0;\n\n    //Add a default order to the items\n    _(definition).map(function(definitionItem) {\n      definitionItem.order = definitionItem.order || (++index) * 10;\n    }).value();\n\n    return definition;\n  }\n\n  getOptions() {\n    return this.options;\n  }\n\n  getModels() {\n    return this.models;\n  }\n\n  getModel(id) {\n    return _(this.models)\n      .filter((model) => {\n        return model.getId() === id;\n      }).first();\n  }\n\n  getNamespace() {\n    return this.name;\n  }\n\n  getMongoose() {\n    return this.getOptions().getMongoose();\n  }\n\n  getExpress() {\n    return this.getOptions().getExpress();\n  }\n\n  getRootRoute() {\n    return this.getOptions().getRootRoute();\n  }\n\n  getApiRoute() {\n    return `${this.getRootRoute()}/api`;\n  }\n\n  getSchema() {\n    return this._schema;\n  }\n\n  getSchemaController() {\n    return this._schemaController;\n  }\n\n  getSchemaMetaId() {\n    return 'CmeasyMetaSchema';\n  }\n\n  getSchemaCrud() {\n    return this._schemaCrud;\n  }\n\n  getSchemaFormly() {\n    return this._schemaFormly;\n  }\n\n  getIdKey() {\n    return CMEASY_ID;\n  }\n\n  getInstanceKey() {\n    return CMEASY_INSTANCE_ID;\n  }\n\n}\n\n\n/**\n * TODO\n */\nclass CmeasyOptions {\n\n  constructor(options) {\n\n    this.options = options;\n\n    if (!this.isUserDefinedMongoose()) {\n      this.connectToMongo();\n    }\n    if (!this.isUserDefinedEnvironment()) {\n      this.options.environment = 'production';\n    }\n\n    this.seedMongo();\n\n  }\n\n  //TODO config urls\n  connectToMongo() {\n    if (!mongoose.connection.readyState) {\n      mongoose.connect(config.mongo.uri, config.mongo.options);\n      mongoose.connection.on('error', function(err) {\n        console.error('MongoDB connection error: ' + err);\n        process.exit(-1);\n      });\n    }\n  }\n\n  //TODO always seed - i.e. fix tests to handle initial seed\n  seedMongo() {\n    if (config.seedDB) {\n      require('./config/seed')();\n    }\n  }\n\n  getMongoose() {\n    return (this.options.mongoose && Promise.promisifyAll(this.options.mongoose)) || Promise.promisifyAll(mongoose);\n  }\n\n  isUserDefinedEnvironment() {\n    return !!this.options.environment;\n  }\n\n  isUserDefinedMongoose() {\n    return !!this.options.mongoose;\n  }\n\n  isUserDefinedExpressApp() {\n    return !!this.options.express;\n  }\n\n  getExpress() {\n    return this.options.express || express;\n  }\n\n  getRootRoute() {\n    return this.options.rootRoute || 'admin';\n  }\n\n}\n\n\n/**\n *\n */\nclass CmeasyModel {\n\n  constructor(cmeasy, model) {\n\n    this.meta = model.meta;\n    this.definition = model.definition;\n\n    this.cmeasy = cmeasy;\n\n    this._model = createModel(cmeasy, cmeasy.getMongoose(), this);\n    this._modelController = createModelController(this, cmeasy.getSchemaController());\n    this._modelFormly = createFormlyController(this.getId(), cmeasy.getSchemaController());\n    this._modelCrud = createCrudController(this.getModelController(), this.getModelFormly());\n\n  }\n\n  getModel() {\n    return this._model;\n  }\n\n\n  getModelFormly() {\n    return this._modelFormly;\n  }\n\n  getModelController() {\n    return this._modelController;\n  }\n\n  getModelCrud() {\n    return this._modelCrud;\n  }\n\n  getId() {\n    return this.meta._cmeasyId;\n  }\n\n  getIdKey() {\n    return CMEASY_ID;\n  }\n\n  getInstanceKey() {\n    return CMEASY_INSTANCE_ID;\n  }\n\n}\n"]}