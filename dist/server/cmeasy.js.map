{"version":3,"sources":["../../server/cmeasy.js"],"names":[],"mappings":"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","file":"cmeasy.js","sourcesContent":["/**\n * Cmeasy\n */\n\n'use strict';\n\nimport _ from 'lodash';\n\nimport Promise from 'bluebird';\nvar mongoose = Promise.promisifyAll(require('mongoose'));\nmongoose.Promise = Promise;\n\nimport express from 'express';\n\nimport config from './config/environment/index';\n\nimport createModel from './components/cmeasy/cmeasy.model';\nimport createSchema from './components/cmeasy/cmeasy.schema';\n\nimport createModelController from './components/cmeasy/cmeasy.controller.model';\nimport createSchemaController from './components/cmeasy/cmeasy.controller.schema';\nimport createFormlyController from './components/cmeasy/cmeasy.controller.formly';\nimport createCrudController from './api/generated/index';\n\nconst CMEASY_ID = '_cmeasyId';\nconst CMEASY_INSTANCE_ID = '_cmeasyInstanceId';\n\n/**\n *\n */\nexport default class Cmeasy {\n\n  constructor(options = {}){\n    this.name = options.name || 'Cmeasy';\n    this.options = options;\n    this.models = [];\n\n    this.connectToMongo();\n\n    this._schema = createSchema(this.getNamespace(), this.getMongoose(), this);\n    this._schemaController = createSchemaController(this);\n    this._schemaFormly = createFormlyController(this.getSchemaMetaId(), this.getSchemaController());\n    this._schemaCrud = createCrudController(this.getSchemaController(), this.getSchemaFormly());\n\n    return Promise.all(this.generateModels(options.models))\n      .then((models) => {\n        return(this);\n      });\n  }\n\n  generateModels(models){\n    return _(models).map(this.initModel.bind(this)).value();\n  }\n\n  initModel(model){\n    return this.getSchemaController()\n      .create(this.getModelSchema(model))\n      .then(this.getAsObject.bind(this))\n      .then(this.createModel.bind(this))\n      .catch(function(error){\n        console.error('error', error);\n      });\n  }\n\n  createModel(model){\n    var existingModel = this.getModel(model.meta._cmeasyId);\n    if(existingModel){\n      return existingModel\n    }\n    else {\n      var newModel = new CmeasyModel(this, model);\n      this.models.push(newModel);\n      return newModel;\n    }\n  }\n\n  getAsObject(obj){\n    return obj.toObject()\n  }\n\n  getModelSchema(model){\n    return {\n      meta: {\n        [this.getIdKey()]: _.camelCase(model.name),\n        author: 'Cmeasy User',\n        comment: 'Cmeasy init',\n        singleton: model.singleton || false,\n        disableDelete: model.disableDelete || false,\n        disableCreate: model.disableCreate || false\n      },\n      definition: model.definition || {}\n    };\n  }\n\n\n  //TODO config urls\n  connectToMongo(){\n\n    var mongoose = this.getMongoose();\n    mongoose.connect(config.mongo.uri, config.mongo.options);\n    mongoose.connection.on('error', function(err) {\n      console.error('MongoDB connection error: ' + err);\n      process.exit(-1);\n    });\n\n    // Populate databases with sample data\n    if (config.seedDB) { require('./config/seed')(); }\n\n    return mongoose;\n  }\n\n\n  getNamespace(){\n    return this.name;\n  }\n\n  getMongoose(){\n    return (this.options.mongoose && Promise.promisifyAll(this.options.mongoose)) || mongoose;\n  }\n\n  getExpress(){\n    return this.options.express || express;\n  }\n\n  getModels(){\n    return this.models;\n  }\n\n  getModel(id){\n    return _(this.models)\n      .filter((model) => { return model.getId() === id; }).first();\n  }\n\n  getRootRoute(){\n    return this.options.rootRoute || 'admin';\n  }\n\n  getApiRoute(){\n    return `${this.getRootRoute()}/api`;\n  }\n\n  getSchema(){\n    return this._schema;\n  }\n\n  getSchemaController(){\n    return this._schemaController;\n  }\n\n  getSchemaMetaId(){\n    return 'CmeasyMetaSchema';\n  }\n  getSchemaCrud(){\n    return this._schemaCrud;\n  }\n\n  getSchemaFormly(){\n    return this._schemaFormly;\n  }\n\n  getIdKey(){\n    return CMEASY_ID;\n  }\n\n  getInstanceKey(){\n    return CMEASY_INSTANCE_ID;\n  }\n\n}\n\n\n/**\n * TODO\n */\nclass CmeasyOptions {\n\n}\n\n\n/**\n *\n */\nclass CmeasyModel {\n\n  constructor(cmeasy, model){\n\n    this.meta = model.meta;\n    this.definition = model.definition;\n\n    this.cmeasy = cmeasy;\n\n    this._model = createModel(cmeasy, cmeasy.getMongoose(), this);\n    this._modelController = createModelController(this, cmeasy.getSchemaController());\n    this._modelFormly = createFormlyController(this.getId(), cmeasy.getSchemaController());\n    this._modelCrud = createCrudController(this.getModelController(), this.getModelFormly());\n\n  }\n\n  getModel(){\n    return this._model;\n  }\n\n  getModelFormly(){\n    return this._modelFormly;\n  }\n\n  getModelController(){\n    return this._modelController;\n  }\n\n  getModelCrud(){\n    return this._modelCrud;\n  }\n\n  getId(){\n    return this.meta._cmeasyId;\n  }\n\n  getIdKey(){\n    return CMEASY_ID;\n  }\n\n  getInstanceKey(){\n    return CMEASY_INSTANCE_ID;\n  }\n\n  isSingleton(){\n    return this.meta.singleton;\n  }\n\n  getDefinition(){\n    return this.definition;\n  }\n\n}\n"]}