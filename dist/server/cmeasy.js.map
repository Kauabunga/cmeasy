{"version":3,"sources":["../../server/cmeasy.js"],"names":[],"mappings":"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","file":"cmeasy.js","sourcesContent":["'use strict';\n\nimport _ from 'lodash';\nimport R from 'ramda';\nimport Promise from 'bluebird';\nconst mongoose = require('mongoose');\nmongoose.Promise = Promise;\n\nimport express from 'express';\n\nimport config from './config/index';\n\nimport createModel from './components/cmeasy/cmeasy.model';\nimport createSchema from './components/cmeasy/cmeasy.schema';\nimport {createInstance} from './components/cmeasy/cmeasy.functions.models';\n\nimport createModelController from './components/cmeasy/cmeasy.controller.model';\nimport createSchemaController from './components/cmeasy/cmeasy.controller.schema';\nimport createFormlyController from './components/cmeasy/cmeasy.controller.formly';\nimport createCrudController from './api/generated/index';\n\nconst debug = require('debug')('cmeasy:cmeasy');\n\nimport User from '../server/api/user/user.model';\n\nconst CMEASY_ID = '_cmeasyId';\nconst CMEASY_INSTANCE_ID = '_cmeasyInstanceId';\n\nexport default class Cmeasy {\n\n  constructor(options = {}) {\n  }\n\n  static create(options) {\n    const instance = new Cmeasy(options);\n    debug('Initialising');\n    instance.name = options.name || 'Cmeasy';\n    instance.options = new CmeasyOptions(options);\n    instance.models = [];\n\n    instance._schema = createSchema(instance.getNamespace(), instance.getMongoose(), instance);\n    instance._schemaController = createSchemaController(instance);\n    instance._schemaFormly = createFormlyController(instance.getSchemaMetaId(), instance.getSchemaController());\n    instance._schemaCrud = createCrudController(instance.getSchemaController(), instance.getSchemaFormly());\n\n    debug('Generating models');\n    return Promise.all(instance.generateModels(options.models))\n      .then(() => {\n        return instance.seedDatabase();\n      })\n      .then(() => {\n        debug('Initialisation complete');\n        return instance;\n      });\n  }\n\n  generateModels(models) {\n    return _(models)\n      .map(this.initModel.bind(this))\n      .value();\n  }\n\n  initModel(model) {\n    return this.getSchemaController()\n      .create(this.getModelSchema(model))\n      .then(this.getAsObject.bind(this))\n      .then(this.createModel.bind(this))\n      .catch(function (error) {\n        console.error('error', error);\n      });\n  }\n\n  createModel(model) {\n    var existingModel = this.getModel(model.meta._cmeasyId);\n\n    if (existingModel) {\n      return existingModel\n    }\n    else {\n      var newModel = new CmeasyModel(this, model);\n      this.models.push(newModel);\n      return newModel;\n    }\n  }\n\n  getAsObject(obj) {\n    return obj.toObject()\n  }\n\n  getModelSchema(model) {\n    return {\n      meta: {\n        [this.getIdKey()]: _.camelCase(model.name),\n        author: 'Cmeasy User',\n        comment: 'Cmeasy init',\n        singleton: model.singleton || false,\n        disableDelete: model.disableDelete || false,\n        disableCreate: model.disableCreate || false\n      },\n      definition: this.getDefaultDefinition(model.definition || {})\n    };\n  }\n\n  getDefaultDefinition(definition) {\n    var index = 0;\n\n    // Add a default order to the items\n    _(definition)\n      .map(function (definitionItem) {\n        definitionItem.order = definitionItem.order || (++index) * 10;\n      })\n      .value();\n\n    return definition;\n  }\n\n  getOptions() {\n    return this.options;\n  }\n\n  getModels() {\n    return this.models;\n  }\n\n  getModel(id) {\n    return _(this.models)\n      .filter((model) => {\n        return model.getId() === id;\n      })\n      .first();\n  }\n\n  getNamespace() {\n    return this.name;\n  }\n\n  getMongoose() {\n    return this.getOptions()\n      .getMongoose();\n  }\n\n  getExpress() {\n    return this.getOptions()\n      .getExpress();\n  }\n\n  getRootRoute() {\n    return this.getOptions()\n      .getRootRoute();\n  }\n\n  getApiRoute() {\n    return `${this.getRootRoute()}/api`;\n  }\n\n  getSchema() {\n    return this._schema;\n  }\n\n  getSchemaController() {\n    return this._schemaController;\n  }\n\n  getSchemaMetaId() {\n    return 'CmeasyMetaSchema';\n  }\n\n  getSchemaCrud() {\n    return this._schemaCrud;\n  }\n\n  getSchemaFormly() {\n    return this._schemaFormly;\n  }\n\n  getIdKey() {\n    return CMEASY_ID;\n  }\n\n  getInstanceKey() {\n    return CMEASY_INSTANCE_ID;\n  }\n\n  seedDatabase() {\n    const debug = require('debug')('cmeasy:cmeasy:seedDatabase');\n    const localOptions = this.getOptions().options;\n    debug('Seeding database');\n    if (!localOptions.initialUsers) {\n      debug('options.initialUsers is null or undefined, using defaults');\n      localOptions.initialUsers = {\n        clean: true,\n        data: [\n          {\n            name: 'Test User',\n            email: 'test@test.com',\n            password: 'test'\n          },\n          {\n            name: 'Admin',\n            role: 'admin',\n            email: 'admin@admin.com',\n            password: 'admin'\n          }\n        ]\n      }\n    }\n\n    let seedActions = Promise.resolve();\n    if (localOptions.initialUsers.clean) {\n      debug('Erasing all users from db');\n      seedActions = User.find({})\n        .remove();\n    }\n\n    seedActions = seedActions\n      .then(() => User.create(localOptions.initialUsers.data))\n      .catch((error) => {\n        debug('Seed database failed');\n        console.error(error);\n        process.exit(1);\n      });\n\n    if (!R.isNil(localOptions.models)) {\n      debug('Checking for model initialData');\n\n      const modelsToSeed = R.filter((model) => {\n        return model.initialData;\n      })(localOptions.models);\n\n      if (!R.isNil(modelsToSeed)) {\n        debug(`Models with initialData: ${modelsToSeed.length}`);\n        seedActions = seedActions.then(() => this.createInitialModelData(modelsToSeed));\n      }\n    }\n\n    return seedActions;\n  }\n\n  createInitialModelData(modelsToSeed) {\n    return Promise.all(modelsToSeed.map((modelDefinition) => {\n      const cmeasyModelName = modelDefinition.definition._cmeasyId.default;\n      const modelDefinitionData = modelDefinition.initialData.data;\n\n      debug(`Enforcing initialData for: ${cmeasyModelName}`);\n\n      let modelActions = Promise.resolve();\n      const cmeasyModel = this.getModel(cmeasyModelName);\n      const mongooseModel = cmeasyModel.getModel();\n\n      // Erase all current model data\n      if (modelDefinition.initialData.clean) {\n        debug(`${cmeasyModelName} has \"clean\" set, clearing all current model data`);\n        modelActions = modelActions.then(() => cmeasyModel.getModel()\n          .find({})\n          .remove());\n      }\n\n      // Check for instances with matching properties & do not update them if present\n      debug(`${cmeasyModelName} checking for instances with properties matching \"initialData.data\"`);\n      modelActions = modelActions.then(() => {\n        return mongooseModel.find({\n          $or: modelDefinition.initialData.data\n        });\n      })\n        .then((modelInstances) => {\n          debug(`${cmeasyModelName} found ${modelInstances.length} matching instances against definition data`);\n\n          return Promise.all(R.map((modelDefinitionDataItem) => {\n            debug(`${cmeasyModelName} checking for presence of ${JSON.stringify(modelDefinitionDataItem)}`);\n\n            // Determine whether one of the returned instances matches the modelDefinition\n            const matchingInstance = R.find((modelInstance) => {\n              const propertyComparison = R.map((modelDefinitionPair) => {\n                return R.propEq.apply(R, modelDefinitionPair);\n              })(R.toPairs(modelDefinitionDataItem));\n              return R.allPass(propertyComparison)(modelInstance);\n            })(modelInstances);\n\n            if (!matchingInstance) {\n              debug(`${cmeasyModelName} no instance found, creating`);\n              return createInstance(this, cmeasyModel, modelDefinitionDataItem);\n            } else {\n              debug(`${cmeasyModelName} instance found, ignoring`);\n              return Promise.resolve();\n            }\n          })(modelDefinitionData));\n\n        });\n\n      return modelActions;\n    }));\n  }\n\n}\n\nclass CmeasyOptions {\n\n  constructor(options) {\n    this.options = options;\n\n    if (!this.isUserDefinedMongoose()) {\n      this.connectToMongo();\n    }\n\n    if (!this.isUserDefinedEnvironment()) {\n      this.options.environment = 'production';\n    }\n  }\n\n  connectToMongo() {\n    if (!mongoose.connection.readyState) {\n      mongoose.connect(config.mongo.uri, config.mongo.options);\n      mongoose.connection.on('error', function (err) {\n        console.error('MongoDB connection error: ' + err);\n        process.exit(-1);\n      });\n    }\n  }\n\n  getMongoose() {\n    return this.options.mongoose || mongoose;\n  }\n\n  isUserDefinedEnvironment() {\n    return !!this.options.environment;\n  }\n\n  isUserDefinedMongoose() {\n    return !!this.options.mongoose;\n  }\n\n  isUserDefinedExpressApp() {\n    return !!this.options.express;\n  }\n\n  getExpress() {\n    return this.options.express || express;\n  }\n\n  getRootRoute() {\n    return this.options.rootRoute || 'admin';\n  }\n\n  getUserModel() {\n    return User;\n  }\n}\n\nclass CmeasyModel {\n\n  constructor(\n    cmeasy,\n    model\n  ) {\n    this.meta = model.meta;\n    this.definition = model.definition;\n\n    this.cmeasy = cmeasy;\n\n    this._model = createModel(cmeasy, cmeasy.getMongoose(), this);\n    this._modelController = createModelController(this, cmeasy);\n    this._modelFormly = createFormlyController(this.getId(), cmeasy.getSchemaController());\n    this._modelCrud = createCrudController(this.getModelController(), this.getModelFormly());\n  }\n\n  getModel() {\n    return this._model;\n  }\n\n  getModelFormly() {\n    return this._modelFormly;\n  }\n\n  getModelController() {\n    return this._modelController;\n  }\n\n  getModelCrud() {\n    return this._modelCrud;\n  }\n\n  getId() {\n    return this.meta._cmeasyId;\n  }\n\n  getIdKey() {\n    return CMEASY_ID;\n  }\n\n  getInstanceKey() {\n    return CMEASY_INSTANCE_ID;\n  }\n}\n"]}