{"version":3,"sources":["../../../../server/api/user/user.integration.js"],"names":[],"mappings":"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","file":"user.integration.js","sourcesContent":["'use strict';\n\n\nvar cmeasy = require('../..');\nimport User from './user.model';\nimport request from 'supertest';\n\n\ndescribe('User API:', function() {\n\n  var user;\n  var adminUser;\n\n  // Clear users before testing\n  before(function() {\n    return User.removeAsync().then(function() {\n      user = new User({\n        name: 'Fake User',\n        email: 'test@example.com',\n        password: 'password'\n      });\n\n      return user.saveAsync()\n        .then(function(savedUser){\n          user = savedUser.toObject();\n        });\n    })\n      .then(function(){\n        adminUser = new User({\n          name: 'Admin User',\n          email: 'admin@example.com',\n          password: 'password',\n          role: 'admin'\n        });\n\n        return adminUser.saveAsync()\n          .then(function(savedUser){\n            adminUser = savedUser.toObject();\n          });\n      });\n  });\n\n  // Clear users after testing\n  after(function() {\n    return User.removeAsync();\n  });\n\n  /**\n   *\n   */\n  describe('GET /api/users', function() {\n\n    var token;\n\n    before(function (done) {\n      cmeasy.then(function (app) {\n        request(app)\n          .post('/admin/auth/local')\n          .send({\n            email: 'admin@example.com',\n            password: 'password'\n          })\n          .expect(200)\n          .expect('Content-Type', /json/)\n          .end((err, res) => {\n            token = res.body.token;\n            done();\n          });\n      });\n    });\n\n    it('should not get a list of users if they are not authenticated', function(done){\n      cmeasy.then(function(app) {\n        request(app)\n          .get('/admin/api/v1/users')\n          .expect(403)\n          .expect('Content-Type', /json/)\n          .end((err, res) => {\n            done();\n          });\n      });\n    });\n\n    it('should get a list of all users', function(done){\n      cmeasy.then(function(app) {\n        request(app)\n          .get('/admin/api/v1/users')\n          .set('authorization', 'Bearer ' + token)\n          .expect(200)\n          .expect('Content-Type', /json/)\n          .end((err, res) => {\n            res.body.length.should.equal(2);\n            done();\n          });\n      });\n    });\n\n    it('should get a single user', function(done){\n      cmeasy.then(function(app) {\n        request(app)\n          .get('/admin/api/v1/users/' + user._id)\n          .set('authorization', 'Bearer ' + token)\n          .expect(200)\n          .expect('Content-Type', /json/)\n          .end((err, res) => {\n            res.body.name.should.equal(user.name);\n            done();\n          });\n      });\n    });\n\n  });\n\n\n\n  describe('POST /api/users', function() {\n\n    var token;\n\n    before(function(done) {\n      cmeasy.then(function(app){\n        request(app)\n          .post('/admin/auth/local')\n          .send({\n            email: 'test@example.com',\n            password: 'password'\n          })\n          .expect(200)\n          .expect('Content-Type', /json/)\n          .end((err, res) => {\n            token = res.body.token;\n            done();\n          });\n      });\n\n    });\n\n    it('should fail to create a user', function(done){\n      var createUser = {\n        email: 'create@create.com'\n      };\n      cmeasy.then(function(app) {\n        request(app)\n          .post('/admin/api/v1/users')\n          .set('authorization', 'Bearer ' + token)\n          .send(createUser)\n          .expect(422)\n          .expect('Content-Type', /json/)\n          .end((err, res) => {\n\n            console.log(res.statusCode);\n            console.log(res.status);\n\n            done();\n          });\n      });\n    });\n\n\n    it('should fail to create a user with the same email', function(done){\n      var createUser = {\n        email: 'test@example.com'\n      };\n      cmeasy.then(function(app) {\n        request(app)\n          .post('/admin/api/v1/users')\n          .set('authorization', 'Bearer ' + token)\n          .send(createUser)\n          .expect(422)\n          .expect('Content-Type', /json/)\n          .end((err, res) => {\n            done();\n          });\n      });\n    });\n\n    //Note: this needs to run after the GET tests otherwise there will be an added user to the index test\n    it('should create a user', function(done){\n      var createUser = {\n        email: 'create@create.com',\n        password: 'create'\n      };\n      cmeasy.then(function(app) {\n        request(app)\n          .post('/admin/api/v1/users')\n          .set('authorization', 'Bearer ' + token)\n          .send(createUser)\n          .expect(201)\n          .expect('Content-Type', /json/)\n          .end((err, res) => {\n\n            res.body.token.should.not.equal(undefined);\n            res.body.email.should.equal(createUser.email);\n\n            done();\n          });\n      });\n    });\n\n  });\n\n\n\n  /**\n   *\n   */\n  describe('DELETE /api/users', function() {\n\n    var token;\n    var deleteUser;\n\n    before(function (done) {\n      cmeasy.then(function (app) {\n        request(app)\n          .post('/admin/auth/local')\n          .send({\n            email: 'admin@example.com',\n            password: 'password'\n          })\n          .expect(200)\n          .expect('Content-Type', /json/)\n          .end((err, res) => {\n            token = res.body.token;\n\n            //Create a user to delete\n            deleteUser = new User({\n              name: 'Delete User',\n              email: 'delete@delete.com',\n              password: 'password'\n            });\n\n            return deleteUser.saveAsync()\n              .then(function(savedUser){\n                deleteUser = savedUser.toObject();\n                done();\n              });\n\n          });\n      });\n    });\n\n    it('should destroy a user', function(done){\n      cmeasy.then(function(app) {\n        request(app)\n          .delete('/admin/api/v1/users/' + deleteUser._id)\n          .set('authorization', 'Bearer ' + token)\n          .expect(204)\n          .expect('Content-Type', /json/)\n          .end((err, res) => {\n\n            console.log(res.body);\n\n            done();\n          });\n      });\n    });\n\n  });\n\n\n\n\n  /**\n   *\n   */\n  describe('GET /api/users/me', function() {\n\n    var token;\n\n    before(function(done) {\n      cmeasy.then(function(app){\n        request(app)\n          .post('/admin/auth/local')\n          .send({\n            email: 'test@example.com',\n            password: 'password'\n          })\n          .expect(200)\n          .expect('Content-Type', /json/)\n          .end((err, res) => {\n            token = res.body.token;\n            done();\n          });\n      });\n\n    });\n\n    it('should respond with a user profile when authenticated', function(done) {\n      cmeasy.then(function(app) {\n        request(app)\n          .get('/admin/api/v1/users/me')\n          .set('authorization', 'Bearer ' + token)\n          .expect(200)\n          .expect('Content-Type', /json/)\n          .end((err, res) => {\n            res.body._id.toString().should.equal(user._id.toString());\n            done();\n          });\n      });\n    });\n\n    it('should respond with a 401 when not authenticated', function(done) {\n      cmeasy.then(function(app) {\n        request(app)\n          .get('/admin/api/v1/users/me')\n          .expect(401)\n          .end(done);\n      });\n    });\n  });\n});\n"]}