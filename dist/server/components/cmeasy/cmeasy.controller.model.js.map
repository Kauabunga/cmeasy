{"version":3,"sources":["../../../../server/components/cmeasy/cmeasy.controller.model.js"],"names":[],"mappings":";;;;;;;;;AASA,YAAY,CAAC;;;;;;;;sBAEC,QAAQ;;;;wBACF,UAAU;;;;qCAQvB,2BAA2B;;AAClC,IAAM,KAAK,GAAG,OAAO,CAAC,OAAO,CAAC,CAAC,yBAAyB,CAAC,CAAC;;;;;;qBAK3C,UAAS,KAAK,EAAE,MAAM,EAAE;AACrC,SAAO;AACL,SAAK,EAAE,KAAK;AACZ,cAAU,EAAE,oBAAE,IAAI,CAAC,KAAK,EAAE,WAAW,CAAC;AACtC,UAAM,EAAE,MAAM;AACd,QAAI,EAAE,IAAI;AACV,WAAO,EAAE,OAAO;AAChB,WAAO,EAAE,OAAO;GACjB,CAAC;;;;;AAKF,WAAS,KAAK,GAAG;AACf,SAAK,SAAS,CAAC;AACf,WAAO,2CAAe,MAAM,EAAE,KAAK,CAAC,CACjC,IAAI,CAAC,UAAC,MAAM,EAAK;AAChB,UAAI,8CAAkB,MAAM,CAAC,EAAE;AAC7B,aAAK,8BAA4B,KAAK,CAAC,KAAK,EAAE,CAAG,CAAC;AAClD,eAAO,aAAa,CAAC,KAAK,CAAC,KAAK,EAAE,CAAC;;SAEhC,IAAI,CAAC,UAAC,SAAS;iBAAK,EAAE,CAAC,MAAM,CAAC,SAAS,CAAC;SAAA,CAAC,CAAC;OAC9C;;AAED,WAAK,qCAAmC,KAAK,CAAC,KAAK,EAAE,CAAG,CAAC;AACzD,aAAO,KAAK,CAAC,QAAQ,EAAE,CACpB,IAAI,CAAC,EAAE,CAAC,CACR,IAAI,CAAC,0CAAc,CAAC,CAAC,IAAI,EAAE,CAC3B,IAAI,CAAC,YAAY,CAAC,KAAK,EAAE,MAAM,CAAC,CAAC,CAAC;KACtC,CAAC,CAAC;GACN;;;;;AAKD,WAAS,IAAI,CAAC,EAAE,EAAE;AAChB,SAAK,0BAAwB,KAAK,CAAC,KAAK,EAAE,kBAAa,EAAE,CAAG,CAAC;AAC7D,WAAO,2CAAe,MAAM,EAAE,KAAK,CAAC,CACjC,IAAI,CAAC,UAAC,MAAM,EAAK;AAChB,WAAK,kCAAkC,CAAC;AACxC,UAAI,8CAAkB,MAAM,CAAC,EAAE;AAC7B,aAAK,2CAA2C,CAAC;AACjD,eAAO,aAAa,CAAC,EAAE,CAAC,CAAC;OAC1B;;AAED,WAAK,qDAAmD,EAAE,CAAG,CAAC;AAC9D,aAAO,yCAAa,EAAE,EAAE,KAAK,CAAC,CAAC;KAChC,CAAC,CACD,IAAI,CAAC,UAAS,IAAI,EAAE;AACnB,WAAK,oCAAkC,KAAK,CAAC,KAAK,EAAE,0BAAqB,EAAE,qBAAgB,IAAI,CAAG,CAAC;AACnG,aAAO,IAAI,CAAC;KACb,CAAC,CAAC;GACN;;;;;;AAMD,WAAS,aAAa,CAAC,EAAE,EAAE;AACzB,WAAO,KAAK,CAAC,QAAQ,EAAE,CACpB,IAAI,CAAC,uCAAW,EAAE,EAAE;AACnB,UAAI,EAAE;AACJ,iBAAS,EAAE,IAAI;OAChB;KACF,EAAE,KAAK,CAAC,CAAC,CACT,IAAI,CAAC,0CAAc,CAAC,CAAC,IAAI,EAAE,CAC3B,IAAI,CAAC,UAAS,KAAK,EAAE;;AAEpB,UAAI,CAAC,KAAK,IAAI,KAAK,CAAC,MAAM,KAAK,CAAC,EAAE;AAChC,eAAO,MAAM,CAAC,EAAE,CAAC,CAAC;OACnB,MAAM;AACL,eAAO,yBAAE,KAAK,CAAC,CAAC,KAAK,EAAE,CAAC;OACzB;KACF,CAAC,CAAC;GACN;;;;;AAKD,WAAS,MAAM,GAAY;QAAX,IAAI,yDAAG,EAAE;;AACvB,WAAO,2CAAe,MAAM,EAAE,KAAK,EAAE,IAAI,CAAC,CAAC;GAC5C;;;;;AAKD,WAAS,OAAO,CAAC,EAAE,EAAE;AACnB,WAAO,2CAAe,MAAM,EAAE,KAAK,CAAC,CACjC,IAAI,CAAC,UAAS,MAAM,EAAE;AACrB,aAAO,KAAK,CAAC,QAAQ,EAAE,CACpB,IAAI,CAAC,uCAAW,EAAE,EAAE,MAAM,EAAE,KAAK,CAAC,CAAC,CACnC,IAAI,CAAC,0CAAc,CAAC,CAAC,IAAI,EAAE,CAAC;KAChC,CAAC,CAAC;GACN;;;;;AAKD,WAAS,OAAO,CAAC,EAAE,EAAE;AACnB,WAAO,2CAAe,MAAM,EAAE,KAAK,CAAC,CACjC,IAAI,CAAC,UAAC,MAAM,EAAK;AAChB,aAAO,KAAK,CAAC,QAAQ,EAAE,CACpB,IAAI,CAAC,uCAAW,EAAE,EAAE,MAAM,EAAE,KAAK,CAAC,CAAC,CACnC,IAAI,EAAE,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC;KAC5B,CAAC,CAAC;GACN;;;;;;AAMD,WAAS,UAAU,CAAC,KAAK,EAAE;AACzB,WAAO,sBAAQ,GAAG,CAAC,yBAAE,KAAK,CAAC,CAAC,GAAG,CAAC,UAAC,IAAI;aAAK,IAAI,CAAC,MAAM,EAAE;KAAA,CAAC,CACrD,KAAK,EAAE,CAAC,CAAC;GACb;;AAED,WAAS,YAAY,CAAC,KAAK,EAAE,MAAM,EAAE;AACnC,SAAK,gBAAgB,CAAA;AACrB,WAAO,UAAC,MAAM,EAAK;AACjB,WAAK,+BAA6B,MAAM,CAAG,CAAC;AAC5C,UAAI,8CAAkB,MAAM,CAAC,EAAE;AAC7B,aAAK,sCAAsC,CAAC;AAC5C,eAAO,yBAAE,MAAM,CAAC,CACb,GAAG,CAAC,UAAC,IAAI,EAAK;AACb,iBAAO,IAAI,CAAC,QAAQ,EAAE,CAAC;SACxB,CAAC,CACD,IAAI,CAAC,KAAK,CAAC,QAAQ,EAAE,CAAC,CACtB,KAAK,EAAE,CAAC;OACZ;;AAED,WAAK,0CAA0C,CAAC;AAChD,aAAO,yBAAE,MAAM,CAAC,CACb,GAAG,CAAC,UAAC,IAAI,EAAK;AACb,eAAO,IAAI,CAAC,QAAQ,EAAE,CAAC;OACxB,CAAC,CACD,IAAI,CAAC,KAAK,CAAC,cAAc,EAAE,CAAC,CAC5B,KAAK,EAAE,CAAC;KACZ,CAAC;GACH;;;;;;AAMD,WAAS,WAAW,CAAC,IAAI,EAAE;AACzB,QAAI,OAAO,IAAI,CAAC,IAAI,KAAK,UAAU,EAAE;AACnC,aAAO,IAAI,CAAC,IAAI,CAAC,YAAY,CAAC,CAAC;KAChC,MAAM;AACL,aAAO,YAAY,CAAC,IAAI,CAAC,CAAC;KAC3B;GACF;;;;;;;AAOD,WAAS,YAAY,CAAC,IAAI,EAAE;AAC1B,QAAI,IAAI,YAAY,KAAK,EAAE;AACzB,aAAO,yBAAE,IAAI,CAAC,CAAC,GAAG,CAAC,UAAS,UAAU,EAAE;AACtC,YAAI,OAAO,UAAU,CAAC,QAAQ,KAAK,UAAU,EAAE;AAC7C,iBAAO,oBAAE,IAAI,CAAC,UAAU,CAAC,QAAQ,EAAE,EAAE,kBAAkB,EAAE,CAAC,CAAC;SAC5D,MAAM;AACL,iBAAO,oBAAE,IAAI,CAAC,UAAU,EAAE,kBAAkB,EAAE,CAAC,CAAC;SACjD;OACF,CAAC,CAAC,KAAK,EAAE,CAAC;KACZ,MAAM;AACL,UAAI,OAAO,IAAI,CAAC,QAAQ,KAAK,UAAU,EAAE;AACvC,eAAO,oBAAE,IAAI,CAAC,IAAI,CAAC,QAAQ,EAAE,EAAE,kBAAkB,EAAE,CAAC,CAAC;OACtD,MAAM;AACL,eAAO,oBAAE,IAAI,CAAC,IAAI,EAAE,kBAAkB,EAAE,CAAC,CAAC;OAC3C;KACF;GACF;;;;;AAKD,WAAS,kBAAkB,GAAG;AAC5B,WAAO,CAAC,KAAK,EAAE,KAAK,EAAE,QAAQ,EAAE,SAAS,EAAE,aAAa,CAAC,CAAC;GAC3D;CACF","file":"cmeasy.controller.model.js","sourcesContent":["/**\n * Using Rails-like standard naming convention for endpoints.\n * GET     /api/generated              ->  index\n * POST    /api/generated              ->  create\n * GET     /api/generated/:id          ->  show\n * PUT     /api/generated/:id          ->  update\n * DELETE  /api/generated/:id          ->  destroy\n */\n\n'use strict';\n\nimport _ from 'lodash';\nimport Promise from 'bluebird';\nimport {\n  getSortQuery,\n  showInstance,\n  createInstance,\n  getModelSchema,\n  isSchemaSingleton,\n  getIdQuery\n} from './cmeasy.functions.models';\nconst debug = require('debug')('cmeasy:controller:model');\n\n/**\n * TODO catch and rethrow for ensured logging\n */\nexport default function(model, cmeasy) {\n  return {\n    index: index,\n    indexClean: _.flow(index, cleanObject),\n    create: create,\n    show: show,\n    history: history,\n    destroy: destroy\n  };\n\n  /**\n   * Gets a list of Generateds\n   */\n  function index() {\n    debug(`index`);\n    return getModelSchema(cmeasy, model)\n      .then((schema) => {\n        if (isSchemaSingleton(schema)) {\n          debug(`Returning singleton for ${model.getId()}`);\n          return showSingleton(model.getId())\n          // convert back into an array to keep consistency\n            .then((singleton) => [].concat(singleton));\n        }\n\n        debug(`Returning list of models of id ${model.getId()}`);\n        return model.getModel()\n          .find({})\n          .sort(getSortQuery()).exec()\n          .then(getUniqueIds(model, schema));\n      });\n  }\n\n  /**\n   * Gets a single Generated from the DB\n   */\n  function show(id) {\n    debug(`show:start getting: ${model.getId()} with id: ${id}`);\n    return getModelSchema(cmeasy, model)\n      .then((schema) => {\n        debug(`show getModelSchema successful`);\n        if (isSchemaSingleton(schema)) {\n          debug(`show getModelSchema returning singleton`);\n          return showSingleton(id);\n        }\n\n        debug(`show getModelSchema returning instance with id ${id}`);\n        return showInstance(id, model);\n      })\n      .then(function(item) {\n        debug(`show:finishing with model id: ${model.getId()}, called with id: ${id}, returning: ${item}`);\n        return item;\n      });\n  }\n\n  /**\n   * @param id\n   * @returns {*}\n   */\n  function showSingleton(id) {\n    return model.getModel()\n      .find(getIdQuery(id, {\n        meta: {\n          singleton: true\n        }\n      }, model))\n      .sort(getSortQuery()).exec()\n      .then(function(items) {\n        // if this item is a singleton and there isn't one -> go and create it\n        if (!items || items.length === 0) {\n          return create({});\n        } else {\n          return _(items).first();\n        }\n      });\n  }\n\n  /**\n   * Creates a new Generated in the DB\n   */\n  function create(item = {}) {\n    return createInstance(cmeasy, model, item);\n  }\n\n  /**\n   * Gets the history of an item\n   */\n  function history(id) {\n    return getModelSchema(cmeasy, model)\n      .then(function(schema) {\n        return model.getModel()\n          .find(getIdQuery(id, schema, model))\n          .sort(getSortQuery()).exec();\n      });\n  }\n\n  /**\n   * Deletes a Generated from the DB\n   */\n  function destroy(id) {\n    return getModelSchema(cmeasy, model)\n      .then((schema) => {\n        return model.getModel()\n          .find(getIdQuery(id, schema, model))\n          .exec().then(destroyAll);\n      });\n  }\n\n  /**\n   * @param items\n   * @returns {*}\n   */\n  function destroyAll(items) {\n    return Promise.all(_(items).map((item) => item.remove())\n      .value());\n  }\n\n  function getUniqueIds(model, schema) {\n    debug(`getUniqueIds`)\n    return (entity) => {\n      debug(`getUniqueIds with entity ${entity}`);\n      if (isSchemaSingleton(schema)) {\n        debug(`getUniqueIds entity is a singleton`);\n        return _(entity)\n          .map((item) => {\n            return item.toObject();\n          })\n          .uniq(model.getIdKey())\n          .value();\n      }\n\n      debug(`getUniqueIds entity is not a singleton`);\n      return _(entity)\n        .map((item) => {\n          return item.toObject();\n        })\n        .uniq(model.getInstanceKey())\n        .value();\n    };\n  }\n\n  /**\n   * @param item\n   * @returns {*}\n   */\n  function cleanObject(item) {\n    if (typeof item.then === 'function') {\n      return item.then(_cleanObject);\n    } else {\n      return _cleanObject(item);\n    }\n  }\n\n  /**\n   * @param item\n   * @returns {*}\n   * @private\n   */\n  function _cleanObject(item) {\n    if (item instanceof Array) {\n      return _(item).map(function(singleItem) {\n        if (typeof singleItem.toObject === 'function') {\n          return _.omit(singleItem.toObject(), getCleanProperties());\n        } else {\n          return _.omit(singleItem, getCleanProperties());\n        }\n      }).value();\n    } else {\n      if (typeof item.toObject === 'function') {\n        return _.omit(item.toObject(), getCleanProperties());\n      } else {\n        return _.omit(item, getCleanProperties());\n      }\n    }\n  }\n\n  /**\n   * @returns {string[]}\n   */\n  function getCleanProperties() {\n    return ['_id', '__v', 'author', 'comment', 'dateCreated'];\n  }\n}\n"]}