{"version":3,"sources":["../../../../server/components/cmeasy/cmeasy.controller.schema.js"],"names":[],"mappings":"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","file":"cmeasy.controller.schema.js","sourcesContent":["/**\n * Using Rails-like standard naming convention for endpoints.\n * GET     /api/generated              ->  index\n * POST    /api/generated              ->  create\n * GET     /api/generated/:id          ->  show\n * PUT     /api/generated/:id          ->  update\n * DELETE  /api/generated/:id          ->  destroy\n */\n\n'use strict';\n\nimport _ from 'lodash';\nimport uuid from 'uuid';\nimport Promise from 'bluebird';\n\n/**\n *\n */\nexport default function(cmeasy){\n\n  return {\n    index: index,\n    create: create,\n    show: show,\n    history: history,\n    destroy: destroy\n  };\n\n\n  /**\n   * Gets a list of Generateds\n   *\n   */\n  function index() {\n    return cmeasy.getSchema().find({})\n      .sort(getSchemaSortQuery()).execAsync()\n      .then(getUniqueIds(cmeasy))\n      .then(removeMetaSchema(cmeasy));\n  }\n\n\n  /**\n   * Gets a single Generated from the DB\n   *\n   */\n  function show(id) {\n\n    console.log(`Schema:Show:Start:${id}`);\n\n    return cmeasy.getSchema().find(getSchemaShowQuery(id)).sort(getSchemaSortQuery()).execAsync()\n      .then(function(items){\n        return _(items).first();\n      })\n      .then(function(item = {}){\n        console.log(`Schema:Show:Finish:${id}:${item}`);\n        return item;\n      });\n  }\n\n\n  /**\n   * Creates a new Generated in the DB\n   *\n   */\n  function create(item) {\n\n    console.log(`Schema:Create:Start:${item.meta && item.meta._cmeasyId}`);\n\n    //TODO If there is no schema id then explode??\n\n    var itemId = getIdFromItem(item, cmeasy);\n\n    if( ! itemId){\n      console.error('No type passed to create schema');\n      return Promise.reject(new Error(400));\n    }\n    //If id === metaSchema the reject\n    else if(itemId === cmeasy.getSchemaMetaId()){\n      console.error('Attempted to create meta schema');\n      return Promise.reject(new Error(400));\n    }\n\n    return cmeasy.getSchema()\n      .createAsync(getDefaultSchema(cmeasy, item))\n      .then(function(item){\n        console.log(`Schema:Create:Finish:${item.meta && item.meta._cmeasyId}`);\n        return item;\n      });\n  }\n\n\n  /**\n   * Gets the history of an item\n   *\n   */\n  function history(id) {\n    return cmeasy.getSchema()\n      .find(getSchemaShowQuery(id))\n      .sort(getSchemaSortQuery())\n      .execAsync();\n  }\n\n\n  /**\n   * Deletes a Schema from the DB\n   */\n  function destroy(id) {\n    return cmeasy.getSchema()\n      .find(getSchemaShowQuery(id))\n      .execAsync()\n      .then(destroyAll);\n  }\n\n\n  /**\n   *\n   * @param item\n   * @returns {*}\n   */\n  function destroyAll(items){\n    return Promise.all(_(items).map((item) => { return item.removeAsync(); }).value());\n  }\n\n\n  /**\n   *\n   */\n  function getSchemaSortQuery(){\n    return { 'meta.dateCreated': -1 };\n  }\n\n\n  /**\n   * TODO get by _cmeasyInstanceId so the _cmeasyId can be changed\n   *\n   * @param id\n   */\n  function getSchemaShowQuery(id){\n    return { 'meta._cmeasyId': id };\n  }\n\n\n  /**\n   * TODO api check on definition\n   */\n  function getDefaultSchema(cmeasy, item){\n    return {\n      meta: _.omit(item.meta, ['dateCreated', 'author', 'comment']), //TODO we should be filtering the values in here using isSchemaEditDisabled\n      definition: _.merge(item.definition, getBaseSchema(cmeasy, item))\n    };\n  }\n\n\n  /**\n   * TODO use this to protect some of the core meta properties\n   */\n  function isSchemaEditDisabled(schema, key){\n    return ['_id', '__v'].indexOf(key) !== -1 || ! schema[key] || schema[key].disableSchemaEdit;\n  }\n\n\n\n  /**\n   * TODO this should be grabbed from the meta schema meta?????\n   *\n   * TODO create public content types that can be submitted to\n   */\n  function getBaseSchema(cmeasy, item){\n\n    return {\n\n      dateCreated: {\n        type: 'Date',\n        default: Date.now,\n        disableEdit: true,\n        disableSchemaEdit: true,\n        disableDisplay: true,\n        unique: false,\n        required: true\n      },\n\n      author: {\n        type: 'String',\n        default: 'Server',\n        disableEdit: true,\n        disableSchemaEdit: true,\n        disableDisplay: true,\n        unique: false\n      },\n\n      comment: {\n        type: 'String',\n        default: 'Server',\n        disableEdit: false,\n        disableSchemaEdit: true,\n        disableDisplay: true,\n        unique: false\n      },\n\n      [cmeasy.getIdKey()]: {\n        type: 'String',\n        default: getIdFromItem(item, cmeasy),\n        disableEdit: true,\n        disableSchemaEdit: true,\n        disableDisplay: true,\n        unique: false,\n        required: true\n      },\n\n      [cmeasy.getInstanceKey()]: {\n        type: 'String',\n        default: () => uuid.v4(),\n        disableEdit: true,\n        disableSchemaEdit: true,\n        disableDisplay: true,\n        unique: false,\n        required: true\n      }\n\n    }\n  }\n\n}\n\n/**\n *\n */\nfunction getIdFromItem(item, cmeasy){\n  return item && item.meta && item.meta[cmeasy.getIdKey()];\n}\n\n\n/**\n *\n */\nfunction getUniqueIds(cmeasy){\n  return function (entity) {\n    return _(entity)\n      .map((item)=>{ return item.toObject(); })\n\n      //TODO this seems to be failing when upgrading to lodash 4.0.0???\n      .uniq('meta.' + cmeasy.getIdKey())\n      .value();\n\n  };\n}\n\n/**\n *\n */\nfunction removeMetaSchema(cmeasy){\n  return function (items = []){\n    return _([].concat(items)).filter(isMetaSchema(cmeasy)).value();\n  }\n}\n\n/**\n *\n */\nfunction isMetaSchema(cmeasy){\n  return function (item){\n    return ! item.meta || item.meta[cmeasy.getIdKey()] !== cmeasy.getSchemaMetaId();\n  }\n}\n\n\n"]}