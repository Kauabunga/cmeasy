{"version":3,"sources":["../../../../server/components/cmeasy/cmeasy.controller.schema.js"],"names":[],"mappings":"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","file":"cmeasy.controller.schema.js","sourcesContent":["/**\n * Using Rails-like standard naming convention for endpoints.\n * GET     /api/generated              ->  index\n * POST    /api/generated              ->  create\n * GET     /api/generated/:id          ->  show\n * PUT     /api/generated/:id          ->  update\n * DELETE  /api/generated/:id          ->  destroy\n */\n\n'use strict';\n\nimport _ from 'lodash';\nimport uuid from 'uuid';\nimport Promise from 'bluebird';\nconst debug = require('debug')('cmeasy:controller:schema');\n\nexport default function(cmeasy) {\n\n  return {\n    index: index,\n    create: create,\n    show: show,\n    history: history,\n    destroy: destroy\n  };\n\n  /**\n   * Gets a list of Generateds\n   */\n  function index() {\n    return cmeasy.getSchema().find({})\n      .sort(getSchemaSortQuery()).execAsync()\n      .then(getUniqueIds(cmeasy))\n      .then(removeMetaSchema(cmeasy));\n  }\n\n  /**\n   * Gets a single Generated from the DB\n   */\n  function show(id) {\n    debug(`show:start:${id}`);\n\n    return cmeasy.getSchema()\n      .find(getSchemaShowQuery(id))\n      .sort(getSchemaSortQuery())\n      .execAsync()\n      .then(function(items) {\n        return _(items).first();\n      })\n      .then(function(item = {}) {\n        debug(`show:finish:${id}:${item}`);\n        return item;\n      });\n  }\n\n  /**\n   * Creates a new Generated in the DB\n   */\n  function create(item) {\n\n    debug(`Schema:Create:Start:${item.meta && item.meta._cmeasyId}`);\n\n    //TODO If there is no schema id then explode??\n\n    var itemId = getIdFromItem(item, cmeasy);\n\n    if (!itemId) {\n      console.error('No type passed to create schema');\n      return Promise.reject(new Error(400));\n    }\n    //If id === metaSchema the reject\n    else if (itemId === cmeasy.getSchemaMetaId()) {\n      console.error('Attempted to create meta schema');\n      return Promise.reject(new Error(400));\n    }\n\n    return cmeasy.getSchema()\n      .createAsync(getDefaultSchema(cmeasy, item))\n      .then(function(item) {\n        debug(`create:finish:${item.meta && item.meta._cmeasyId}`);\n        return item;\n      });\n  }\n\n  /**\n   * Gets the history of an item\n   */\n  function history(id) {\n    return cmeasy.getSchema()\n      .find(getSchemaShowQuery(id))\n      .sort(getSchemaSortQuery())\n      .execAsync();\n  }\n\n  /**\n   * Deletes a Schema from the DB\n   */\n  function destroy(id) {\n    return cmeasy.getSchema()\n      .find(getSchemaShowQuery(id))\n      .execAsync()\n      .then(destroyAll);\n  }\n\n  /**\n   * @param item\n   * @returns {*}\n   */\n  function destroyAll(items) {\n    return Promise.all(_(items).map((item) => {\n      return item.removeAsync();\n    }).value());\n  }\n\n  function getSchemaSortQuery() {\n    return {'meta.dateCreated': -1};\n  }\n\n  /**\n   * TODO get by _cmeasyInstanceId so the _cmeasyId can be changed\n   *\n   * @param id\n   */\n  function getSchemaShowQuery(id) {\n    return {'meta._cmeasyId': id};\n  }\n\n\n  /**\n   * TODO api check on definition\n   */\n  function getDefaultSchema(cmeasy, item) {\n    return {\n      meta: _.omit(item.meta, ['dateCreated', 'author', 'comment']), //TODO we should be filtering the values in here using isSchemaEditDisabled\n      definition: _.merge(item.definition, getBaseSchema(cmeasy, item))\n    };\n  }\n\n  /**\n   * TODO use this to protect some of the core meta properties\n   */\n  function isSchemaEditDisabled(schema, key) {\n    return ['_id', '__v'].indexOf(key) !== -1 || !schema[key] || schema[key].disableSchemaEdit;\n  }\n\n  /**\n   * TODO this should be grabbed from the meta schema meta?\n   * TODO create public content types that can be submitted to\n   */\n  function getBaseSchema(cmeasy, item) {\n    return {\n      dateCreated: {\n        type: 'Date',\n        default: Date.now,\n        disableEdit: true,\n        disableSchemaEdit: true,\n        disableDisplay: true,\n        unique: false,\n        required: true\n      },\n      author: {\n        type: 'String',\n        default: 'Server',\n        disableEdit: true,\n        disableSchemaEdit: true,\n        disableDisplay: true,\n        unique: false\n      },\n      comment: {\n        type: 'String',\n        default: 'Server',\n        disableEdit: false,\n        disableSchemaEdit: true,\n        disableDisplay: true,\n        unique: false\n      },\n      [cmeasy.getIdKey()]: {\n        type: 'String',\n        default: getIdFromItem(item, cmeasy),\n        disableEdit: true,\n        disableSchemaEdit: true,\n        disableDisplay: true,\n        unique: false,\n        required: true\n      },\n      [cmeasy.getInstanceKey()]: {\n        type: 'String',\n        default: () => uuid.v4(),\n        disableEdit: true,\n        disableSchemaEdit: true,\n        disableDisplay: true,\n        unique: false,\n        required: true\n      }\n    }\n  }\n\n}\n\nfunction getIdFromItem(item, cmeasy) {\n  return item && item.meta && item.meta[cmeasy.getIdKey()];\n}\n\nfunction getUniqueIds(cmeasy) {\n  return function(entity) {\n    return _(entity)\n      .map((item) => {\n        return item.toObject();\n      })\n\n      // TODO this seems to be failing when upgrading to lodash 4.0.0?\n      .uniq('meta.' + cmeasy.getIdKey())\n      .value();\n\n  };\n}\n\nfunction removeMetaSchema(cmeasy) {\n  return function(items = []) {\n    return _([].concat(items)).filter(isMetaSchema(cmeasy)).value();\n  }\n}\n\nfunction isMetaSchema(cmeasy) {\n  return function(item) {\n    return !item.meta || item.meta[cmeasy.getIdKey()] !== cmeasy.getSchemaMetaId();\n  }\n}\n"]}