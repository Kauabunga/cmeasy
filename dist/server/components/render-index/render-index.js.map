{"version":3,"sources":["../../../../server/components/render-index/render-index.js"],"names":[],"mappings":";;AAEA,YAAY,CAAC;;;;;;;;;;wBAGO,UAAU;;;;oBACb,MAAM;;;;kBACR,IAAI;;;;iCACA,0BAA0B;;;;oBAC5B,MAAM;;;;4BACA,eAAe;;mBACtB,KAAK;;;;;;;;qBAMN,UAAS,GAAG,EAAE,MAAM,EAAE;;AAEnC,MAAI,YAAY,YAAA,CAAC;;AAEjB,SAAO,SAAS,eAAe,CAAC,GAAG,EAAE,GAAG,EAAE,IAAI,EAAC;;AAE7C,QAAI,QAAQ,GAAG,kBAAK,EAAE,EAAE,CAAC,OAAO,CAAC,IAAI,EAAE,EAAE,CAAC,CAAC;;AAE3C,WAAO,sBAAQ,GAAG,CAAC,CAAC,gBAAgB,EAAE,EAAE,oBAAoB,CAAC,QAAQ,CAAC,CAAC,CAAC,CACrE,IAAI,CAAC,UAAS,IAAqC,EAAC;iCAAtC,IAAqC;;UAApC,gBAAgB;UAAE,iBAAiB;;AACjD,aAAO,GAAG,CAAC,MAAM,CAAC,cAAc,EAAE,0BAA0B,CAAC,CAC1D,GAAG,CAAC,gBAAgB,CAAC,iBAAiB,CAAC,CAAC,CAAC;KAC7C,CAAC,SACI,CAAC,UAAS,GAAG,EAAC;AAClB,aAAO,CAAC,KAAK,CAAC,4BAA4B,EAAE,GAAG,CAAC,CAAC;AACjD,aAAO,GAAG,CAAC,UAAU,CAAC,GAAG,CAAC,CAAC;KAC5B,CAAC,CAAC;GAEN,CAAC;;;;;AAKF,WAAS,oBAAoB,CAAC,QAAQ,EAAC;AACrC,WAAO,sBAAQ,GAAG,CAAC,CAAC,MAAM,CAAC,mBAAmB,EAAE,CAAC,KAAK,EAAE,CAAC,CAAC,CACvD,IAAI,CAAC,UAAS,KAAQ,EAAC;kCAAT,KAAQ;;UAAP,MAAM;;AAEpB,aAAO;AACL,cAAM,EAAE,IAAI,CAAC,SAAS,CAAC;AACrB,aAAG,EAAE,+BAAO,GAAG;AACf,iBAAO,EAAE,+BAAO,OAAO;AACvB,mBAAS,EAAE,MAAM,CAAC,YAAY,EAAE;AAChC,gBAAM,EAAE,MAAM;;SAEf,CAAC;AACF,gBAAQ,EAAE,QAAQ;AAClB,uBAAe,EAAE,MAAM,CAAC,YAAY,EAAE,GAAG,GAAG;;OAE7C,CAAC;KAEH,CAAC,CAAC;GACN;;;;;AAKD,WAAS,gBAAgB,GAAE;AACzB,QAAI,CAAE,YAAY,IAAI,+BAAO,GAAG,KAAK,aAAa,EAAC;AACjD,aAAO,0BAAY,UAAC,OAAO,EAAE,OAAO,EAAK;AACvC,eAAO,gBAAG,QAAQ,CAAC,gBAAgB,EAAE,EAAE,MAAM,EAAE,UAAS,GAAG,EAAE,aAAa,EAAC;AACzE,cAAG,GAAG,EAAC;AACL,mBAAO,OAAO,CAAC,GAAG,CAAC,CAAC;WACrB,MACI;AACH,mBAAO,OAAO,CAAC,iBAAI,OAAO,CAAC,cAAc,CAAC,aAAa,CAAC,EAAE,EAAE,YAAY,EAAE,IAAI,EAAE,CAAC,CAAC,CAAC;WACpF;SACF,CAAC,CAAC;OACJ,CAAC,CAAC;KACJ,MACI;AACH,aAAO,sBAAQ,OAAO,CAAC,YAAY,CAAC,CAAC;KACtC;GACF;;;;;;AAMD,WAAS,cAAc,CAAC,QAAQ,EAAC;AAC/B,WAAO,0BAAO,QAAQ,EAAE;AACtB,cAAQ,EAAE,IAAI;AACd,eAAS,EAAE,IAAI;AACf,oBAAc,EAAE,IAAI;KACrB,CAAC,CAAC;GACJ;;;;;AAKD,WAAS,gBAAgB,GAAE;AACzB,WAAO,kBAAK,OAAO,CAAC,GAAG,CAAC,GAAG,CAAC,SAAS,CAAC,GAAG,sBAAsB,CAAC,CAAC;GAClE;CAEF","file":"render-index.js","sourcesContent":["\n\n'use strict';\n\n\nimport Promise from 'bluebird';\nimport path from 'path';\nimport fs from 'fs';\nimport config from '../../config/environment';\nimport uuid from 'uuid';\nimport { minify } from 'html-minifier';\nimport ejs from 'ejs';\n\n\n/**\n *\n */\nexport default function(app, cmeasy) {\n\n  let indexDotHtml;\n\n  return function renderIndexHtml(req, res, next){\n\n    var cspNonce = uuid.v4().replace(/-/g, '');\n\n    return Promise.all([getIndexAsString(), getInjectedVariables(cspNonce)])\n      .then(function([ejsIndexTemplate, injectedVariables]){\n        return res.header('content-type', 'text/html; charset=UTF-8')\n          .end(ejsIndexTemplate(injectedVariables));\n      })\n      .catch(function(err){\n        console.error('Error rendering index.html', err);\n        return res.sendStatus(500);\n      });\n\n  };\n\n  /**\n   *\n   */\n  function getInjectedVariables(cspNonce){\n    return Promise.all([cmeasy.getSchemaController().index()])\n      .then(function([models]){\n\n        return {\n          cmeasy: JSON.stringify({\n            env: config.env,\n            version: config.version,\n            rootRoute: cmeasy.getRootRoute(),\n            models: models\n\n          }),\n          cspNonce: cspNonce,\n          rootStaticRoute: cmeasy.getRootRoute() + '/'\n          //rootStaticRoute: ''\n        };\n\n      });\n  }\n\n  /**\n   *\n   */\n  function getIndexAsString(){\n    if( ! indexDotHtml || config.env === 'development'){\n      return new Promise((success, failure) => {\n        return fs.readFile(getIndexFilePath(), 'utf8', function(err, indexTemplate){\n          if(err){\n            return failure(err);\n          }\n          else {\n            return success(ejs.compile(minifyTemplate(indexTemplate), { rmWhitespace: true }));\n          }\n        });\n      });\n    }\n    else {\n      return Promise.resolve(indexDotHtml);\n    }\n  }\n\n  /**\n   *\n   * @param template\n   */\n  function minifyTemplate(template){\n    return minify(template, {\n      minifyJS: true,\n      minifyCSS: true,\n      removeComments: true\n    });\n  }\n\n  /**\n   *\n   */\n  function getIndexFilePath(){\n    return path.resolve(app.get('appPath') + '/index.template.html');\n  }\n\n}\n\n\n\n"]}